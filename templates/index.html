<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…ç…¤ç¨‹åº</title>
    {#    <script src="https://cdn.tailwindcss.com"></script>#}
    {#    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">#}
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/font-awesome.min.css" rel="stylesheet">
    <script src="/static/js/chart.umd.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
<header class="bg-blue-600 text-white p-4">
    <div class="container mx-auto">
        <h1 class="text-2xl md:text-3xl font-bold" style="display:flex; align-items:center;">
            <img src="/static/logo.png" style="width:170px; height:auto; margin-right:16px;margin-left: 20px;"> é…ç…¤ç¨‹åº
        </h1>
    </div>
</header>

<main class="container mx-auto p-4 md:p-6 flex-1">
    <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
    <div class="flex border-b border-gray-200 mb-6">
        <button id="tab-electric" class="tab-btn py-2 px-4 border-b-2 border-blue-500 text-blue-600 font-medium">
            <i class="fa fa-bolt mr-2"></i>ç”µç…¤è®¡ç®—
        </button>
        <button id="tab-coal" class="tab-btn py-2 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
            <i class="fa fa-coffee mr-2"></i>åŸç…¤ç®¡ç†
        </button>
        <button id="tab-blend"
                class="tab-btn py-2 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
            <i class="fa fa-calculator mr-2"></i>é…ç…¤è®¡ç®—-å¾…å®Œå–„
        </button>
        <button id="tab-result"
                class="tab-btn py-2 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
            <i class="fa fa-bar-chart mr-2"></i>è®¡ç®—ç»“æœ-å¾…å®Œå–„
        </button>
    </div>

    <!-- åŸç…¤ç®¡ç†é¢æ¿ -->
    <div id="panel-coal" class="tab-panel hidden">
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <h2 class="text-xl font-semibold mb-4">æ·»åŠ åŸç…¤</h2>
            <form id="coal-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-gray-700 mb-1">åŸç…¤åç§°</label>
                    <input type="text" id="coal-name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">å‘çƒ­é‡ (å¤§å¡)</label>
                    <input type="number" id="coal-calorific" step="0.1" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">ç°åˆ† (%)</label>
                    <input type="number" id="coal-ash" step="0.01" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">ç¡«åˆ† (%)</label>
                    <input type="number" id="coal-sulfur" step="0.01" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">ä»·æ ¼ (å…ƒ/å¨)</label>
                    <input type="number" id="coal-price" step="0.1" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">çŸ­å€’è´¹ (å…ƒ/å¨)</label>
                    <input type="number" id="coal-short-transport" step="0.1" value="0"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">è¿‡ç­›è´¹ (å…ƒ/å¨)</label>
                    <input type="number" id="coal-screening-fee" step="0.1" value="0"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">ç ´ç¢è´¹ (å…ƒ/å¨)</label>
                    <input type="number" id="coal-crushing-fee" step="0.1" value="0"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex items-end space-x-3">
                    <button id="coal-submit-btn" type="submit"
                            class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fa fa-plus mr-1"></i>æ·»åŠ 
                    </button>
                    <button id="coal-delete-btn" type="button"
                            class="hidden bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                        <i class="fa fa-trash mr-1"></i>åˆ é™¤
                    </button>
                    <button id="coal-cancel-btn" type="button"
                            class="hidden bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                        <i class="fa fa-times mr-1"></i>å–æ¶ˆç¼–è¾‘
                    </button>
                </div>
            </form>
        </div>

        <div class="bg-white rounded-lg shadow-md p-4">
            <h2 class="text-xl font-semibold mb-4">åŸç…¤åˆ—è¡¨</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                    <tr class="bg-gray-100">
                        <th class="py-2 px-4 border">åç§°</th>
                        <th class="py-2 px-4 border">å‘çƒ­é‡</th>
                        <th class="py-2 px-4 border">ç°åˆ†</th>
                        <th class="py-2 px-4 border">ç¡«åˆ†</th>
                        <th class="py-2 px-4 border">ä»·æ ¼</th>
                        <th class="py-2 px-4 border">çŸ­å€’è´¹</th>
                        <th class="py-2 px-4 border">è¿‡ç­›è´¹</th>
                        <th class="py-2 px-4 border">ç ´ç¢è´¹</th>
                    </tr>
                    </thead>
                    <tbody id="coal-table-body">
                    <!-- åŸç…¤æ•°æ®å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- é…ç…¤è®¡ç®—é¢æ¿ -->
    <div id="panel-blend" class="tab-panel hidden">
        <div class="bg-white rounded-lg shadow-md p-4">
            <h2 class="text-xl font-semibold mb-4">é…ç…¤ç›®æ ‡è®¾ç½®</h2>
            <form id="blend-form" class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-1">æœ€ä½å‘çƒ­é‡ (å¤§å¡)</label>
                    <input type="number" id="target-calorific" step="0.1" value="5500" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">æœ€é«˜ç°åˆ† (%)</label>
                    <input type="number" id="target-ash" step="0.01" value="13" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">æœ€é«˜ç¡«åˆ† (%)</label>
                    <input type="number" id="target-sulfur" step="0.01" value="0.8" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <button type="submit"
                        class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700">
                    <i class="fa fa-calculator mr-1"></i>è®¡ç®—æœ€ä¼˜é…æ¯”
                </button>
            </form>
        </div>
    </div>

    <!-- ç”µç…¤è®¡ç®—é¢æ¿ -->
    <div id="panel-electric" class="tab-panel">
        <div class="bg-white rounded-lg shadow-md p-4">
            <h2 class="text-xl font-semibold mb-4">ç”µç…¤ç›®æ ‡è®¾ç½®</h2>
            <form id="electric-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-1">ç›®æ ‡å‘çƒ­é‡ (å¤§å¡)</label>
                        <input type="number" id="electric-calorific" step="0.1" value="5000" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">é€‰æ‹©å‚ä¸é…æ¯”çš„åŸç…¤</label>
                        <!-- è§¦å‘æŒ‰é’® -->
                        <div class="relative">
                            <button type="button" id="coal-select-btn"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-left bg-white hover:bg-gray-50 flex justify-between items-center">
                                <span id="selected-coals-text">å…¨éƒ¨åŸç…¤</span>
                                <i class="fa fa-chevron-down"></i>
                            </button>
                            <!-- å¼¹å‡ºå±‚ -->
                            <div id="coal-select-modal"
                                 class="hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-md shadow-lg z-50 max-h-80 overflow-auto">
                                <table class="min-w-full">
                                    <thead>
                                    <tr class="bg-gray-100">
                                        <th class="py-2 px-3 border text-center">é€‰æ‹©</th>
                                        <th class="py-2 px-3 border">åç§°</th>
                                        <th class="py-2 px-3 border">å‘çƒ­é‡</th>
                                        <th class="py-2 px-3 border">ä»·æ ¼</th>
                                    </tr>
                                    </thead>
                                    <tbody id="coal-select-table">
                                    <!-- åŠ¨æ€åŠ è½½åŸç…¤æ•°æ® -->
                                    </tbody>
                                </table>
                                <div class="p-2 bg-gray-50 flex justify-between border-t">
                                    <button type="button" id="select-all-coals"
                                            class="px-3 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                        å…¨é€‰
                                    </button>
                                    <button type="button" id="clear-all-coals"
                                            class="px-3 py-1 text-sm bg-gray-500 text-white rounded-md hover:bg-gray-600">
                                        æ¸…ç©º
                                    </button>
                                    <button type="button" id="confirm-coal-selection"
                                            class="px-3 py-1 text-sm bg-green-600 text-white rounded-md hover:bg-green-700">
                                        ç¡®è®¤
                                    </button>
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">ç‚¹å‡»é€‰æ‹©åŸç…¤ï¼Œé»˜è®¤å…¨éƒ¨å‚ä¸</p>
                    </div>
                </div>
                <button type="submit"
                        class="bg-yellow-500 text-white px-6 py-2 rounded-md hover:bg-yellow-600">
                    <i class="fa fa-bolt mr-1"></i>è®¡ç®—ç”µç…¤é…æ¯”
                </button>
            </form>
        </div>

        <!-- ç”µç…¤å¤šæ–¹æ¡ˆç»“æœ -->
        <div id="electric-result" class="bg-white rounded-lg shadow-md p-4 mt-6 hidden">
            <h2 class="text-xl font-semibold mb-4">ç”µç…¤é…æ¯”æ–¹æ¡ˆï¼ˆæŒ‰æˆæœ¬æ’åºï¼‰</h2>
            <div id="electric-plan-list" class="space-y-4"></div>
        </div>
    </div>

    <!-- è®¡ç®—ç»“æœé¢æ¿ -->
    <div id="panel-result" class="tab-panel hidden">
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <h2 class="text-xl font-semibold mb-4">é…ç…¤æŒ‡æ ‡ç»“æœ</h2>
            <div id="result-indicators"
                 class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md">
                <!-- ç»“æœæŒ‡æ ‡å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-4">
            <h2 class="text-xl font-semibold mb-4">é…ç…¤æ¯”ä¾‹</h2>
            <div class="h-64">
                <canvas id="ratio-chart"></canvas>
            </div>
            <div id="ratio-table" class="mt-6">
                <!-- æ¯”ä¾‹è¡¨æ ¼å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>
</main>

<footer class="bg-gray-800 text-white p-4 mt-8">
    <div class="container mx-auto text-center text-sm">
        <p>å—æˆˆå£ å®¡è®¡æ³•åŠ¡ä¸­å¿ƒ &copy; 2025</p>
    </div>
</footer>

<script>
    // æ ‡ç­¾é¡µåˆ‡æ¢
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('border-blue-500', 'text-blue-600');
                b.classList.add('border-transparent', 'text-gray-500');
            });
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.add('hidden');
            });

            btn.classList.remove('border-transparent', 'text-gray-500');
            btn.classList.add('border-blue-500', 'text-blue-600');

            const panelId = btn.id.replace('tab-', 'panel-');
            document.getElementById(panelId).classList.remove('hidden');
        });
    });

    // åŸç…¤é€‰æ‹©ç›¸å…³å˜é‡
    let selectedCoalIds = []; // å­˜å‚¨é€‰ä¸­çš„åŸç…¤ID

    // åŠ è½½åŸç…¤æ•°æ®
    let selectedRow = null;

    function loadCoals() {
        fetch('/api/coals')
            .then(response => response.json())
            .then(coals => {
                const tableBody = document.getElementById('coal-table-body');
                tableBody.innerHTML = '';

                coals.forEach(coal => {
                    const row = document.createElement('tr');
                    row.setAttribute("data-id", coal.id);
                    row.classList.add("cursor-pointer", "hover:bg-blue-50");

                    row.innerHTML = `
                    <td class="py-2 px-4 border">${coal.name}</td>
                    <td class="py-2 px-4 border">${coal.calorific}</td>
                    <td class="py-2 px-4 border">${coal.ash}%</td>
                    <td class="py-2 px-4 border">${coal.sulfur}%</td>
                    <td class="py-2 px-4 border">${coal.price}</td>
                    <td class="py-2 px-4 border">${coal.short_transport ?? 0}</td>
                    <td class="py-2 px-4 border">${coal.screening_fee ?? 0}</td>
                    <td class="py-2 px-4 border">${coal.crushing_fee ?? 0}</td>
                `;

                    row.onclick = () => {
                        if (selectedRow) {
                            selectedRow.classList.remove('bg-blue-100');
                        }
                        row.classList.add('bg-blue-100');
                        selectedRow = row;
                        editCoal(coal);
                    };

                    tableBody.appendChild(row);
                });

                // åŒæ—¶åŠ è½½åŸç…¤é€‰æ‹©è¡¨æ ¼
                loadCoalSelectionTable(coals);
            });
    }

    // åŠ è½½åŸç…¤é€‰æ‹©è¡¨æ ¼
    function loadCoalSelectionTable(coals) {
        const tableBody = document.getElementById('coal-select-table');
        tableBody.innerHTML = '';

        coals.forEach(coal => {
            const row = document.createElement('tr');
            const isSelected = selectedCoalIds.length === 0 || selectedCoalIds.includes(coal.id);

            row.innerHTML = `
                <td class="py-2 px-3 border-b text-center">
                    <input type="checkbox" class="coal-checkbox" data-id="${coal.id}" ${isSelected ? 'checked' : ''}>
                </td>
                <td class="py-2 px-3 border">${coal.name}</td>
                <td class="py-2 px-3 border">${coal.calorific}</td>
                <td class="py-2 px-3 border">${coal.price}</td>
            `;

            tableBody.appendChild(row);
        });
    }

    // åŸç…¤é€‰æ‹©æ¨¡æ€æ¡†åˆ‡æ¢
    document.getElementById('coal-select-btn').addEventListener('click', (e) => {
        e.preventDefault();
        const modal = document.getElementById('coal-select-modal');
        modal.classList.toggle('hidden');
    });

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.addEventListener('click', (e) => {
        const modal = document.getElementById('coal-select-modal');
        const btn = document.getElementById('coal-select-btn');
        if (!modal.contains(e.target) && !btn.contains(e.target)) {
            modal.classList.add('hidden');
        }
    });

    // å…¨é€‰æŒ‰é’®
    document.getElementById('select-all-coals').addEventListener('click', () => {
        document.querySelectorAll('.coal-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });
    });

    // æ¸…ç©ºæŒ‰é’®
    document.getElementById('clear-all-coals').addEventListener('click', () => {
        document.querySelectorAll('.coal-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
    });

    // ç¡®è®¤é€‰æ‹©æŒ‰é’®
    document.getElementById('confirm-coal-selection').addEventListener('click', () => {
        const checkboxes = document.querySelectorAll('.coal-checkbox:checked');
        selectedCoalIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));

        const textElement = document.getElementById('selected-coals-text');
        if (selectedCoalIds.length === 0) {
            textElement.textContent = 'æœªé€‰æ‹©åŸç…¤';
        } else if (document.querySelectorAll('.coal-checkbox').length === selectedCoalIds.length) {
            textElement.textContent = 'å…¨éƒ¨åŸç…¤';
        } else {
            textElement.textContent = `${selectedCoalIds.length}ç§åŸç…¤`;
        }

        document.getElementById('coal-select-modal').classList.add('hidden');
    });

    let editingId = null;

    function editCoal(coal) {
        editingId = coal.id;

        document.getElementById('coal-name').value = coal.name;
        document.getElementById('coal-calorific').value = coal.calorific;
        document.getElementById('coal-ash').value = coal.ash;
        document.getElementById('coal-sulfur').value = coal.sulfur;
        document.getElementById('coal-price').value = coal.price;
        document.getElementById('coal-short-transport').value = coal.short_transport ?? 0;
        document.getElementById('coal-screening-fee').value = coal.screening_fee ?? 0;
        document.getElementById('coal-crushing-fee').value = coal.crushing_fee ?? 0;

        document.getElementById("coal-submit-btn").innerHTML = `<i class="fa fa-save mr-1"></i>ä¿å­˜ä¿®æ”¹`;
        document.getElementById("coal-submit-btn").classList.remove("bg-blue-600");
        document.getElementById("coal-submit-btn").classList.add("bg-green-600");
        const delBtn = document.getElementById("coal-delete-btn");
        if (delBtn) delBtn.classList.remove("hidden");
        document.getElementById("coal-cancel-btn").classList.remove("hidden");
    }

    function resetCoalFormState() {
        editingId = null;
        document.getElementById('coal-form').reset();
        document.getElementById('coal-short-transport').value = 0;
        document.getElementById('coal-screening-fee').value = 0;
        document.getElementById('coal-crushing-fee').value = 0;

        const submitBtn = document.getElementById("coal-submit-btn");
        submitBtn.innerHTML = `<i class="fa fa-plus mr-1"></i>æ·»åŠ `;
        submitBtn.classList.add("bg-blue-600");
        submitBtn.classList.remove("bg-green-600");

        const delBtn = document.getElementById("coal-delete-btn");
        const cancelBtn = document.getElementById("coal-cancel-btn");
        if (delBtn) delBtn.classList.add("hidden");
        if (cancelBtn) cancelBtn.classList.add("hidden");

        if (selectedRow) {
            selectedRow.classList.remove("bg-blue-100");
            selectedRow = null;
        }
    }

    document.getElementById('coal-cancel-btn').addEventListener('click', resetCoalFormState);

    document.getElementById('coal-form').addEventListener('submit', (e) => {
        e.preventDefault();

        const coal = {
            id: editingId,
            name: document.getElementById('coal-name').value,
            calorific: parseFloat(document.getElementById('coal-calorific').value),
            ash: parseFloat(document.getElementById('coal-ash').value),
            sulfur: parseFloat(document.getElementById('coal-sulfur').value),
            price: parseFloat(document.getElementById('coal-price').value),
            short_transport: parseFloat(document.getElementById('coal-short-transport').value || 0),
            screening_fee: parseFloat(document.getElementById('coal-screening-fee').value || 0),
            crushing_fee: parseFloat(document.getElementById('coal-crushing-fee').value || 0)
        };

        fetch('/api/coals', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(coal)
        })
            .then(res => res.json())
            .then(data => {
                alert(editingId ? 'ä¿®æ”¹æˆåŠŸï¼' : 'æ·»åŠ æˆåŠŸï¼');
                resetCoalFormState();
                loadCoals();
            });
    });

    document.getElementById('blend-form').addEventListener('submit', (e) => {
        e.preventDefault();

        const target = {
            min_calorific: parseFloat(document.getElementById('target-calorific').value),
            max_ash: parseFloat(document.getElementById('target-ash').value),
            max_sulfur: parseFloat(document.getElementById('target-sulfur').value)
        };

        fetch('/api/blend', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(target)
        })
            .then(response => response.json())
            .then(result => {
                if (!result.success) {
                    alert(result.message);
                    return;
                }

                document.getElementById('tab-result').click();

                const indicators = document.getElementById('result-indicators');
                const taxCost = (result.æŒ‡æ ‡.å•ä½æˆæœ¬ * 1.13).toFixed(2);
                indicators.innerHTML = `
                    <div>
                        <p class="text-gray-600">å‘çƒ­é‡</p>
                        <p class="text-2xl font-bold">${result.æŒ‡æ ‡.å‘çƒ­é‡} å¤§å¡</p>
                    </div>
                    <div>
                        <p class="text-gray-600">ç°åˆ†</p>
                        <p class="text-2xl font-bold">${result.æŒ‡æ ‡.ç°åˆ†} %</p>
                    </div>
                    <div>
                        <p class="text-gray-600">ç¡«åˆ†</p>
                        <p class="text-2xl font-bold">${result.æŒ‡æ ‡.ç¡«åˆ†} %</p>
                    </div>
                    <div>
                        <p class="text-gray-600">å•ä½æˆæœ¬ï¼ˆä¸å«ç¨ï¼‰</p>
                        <p class="text-2xl font-bold">${result.æŒ‡æ ‡.å•ä½æˆæœ¬} å…ƒ/å¨</p>
                    </div>
                    <div>
                        <p class="text-gray-600">å•ä½æˆæœ¬ï¼ˆå«ç¨ä»·ï¼‰</p>
                        <p class="text-2xl font-bold text-red-600">${taxCost} å…ƒ/å¨</p>
                    </div>
                `;

                const ratioTable = document.getElementById('ratio-table');
                ratioTable.innerHTML = `
                    <table class="min-w-full">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="py-2 px-4 border-b">åŸç…¤åç§°</th>
                                <th class="py-2 px-4 border-b">é…ç…¤æ¯”ä¾‹</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${result.ratio.map(item => `
                                <tr>
                                    <td class="py-2 px-4 border-b">${item.name}</td>
                                    <td class="py-2 px-4 border-b">${item.ratio}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                const ctx = document.getElementById('ratio-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: result.ratio.map(item => item.name),
                        datasets: [{
                            data: result.ratio.map(item => item.ratio),
                            backgroundColor: [
                                '#3e95cd', '#8e5ea2', '#3cba9f',
                                '#e8c3b9', '#c45850', '#ffcc00'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            });
    });

    // ç”µç…¤é…æ¯”è®¡ç®—è¡¨å•æäº¤
    const electricForm = document.getElementById('electric-form');
    if (electricForm) {
        electricForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const target = {
                calorific: parseFloat(document.getElementById('electric-calorific').value),
                selected_coal_ids: selectedCoalIds // ä¼ é€’é€‰ä¸­çš„åŸç…¤ID
            };

            fetch('/api/electric_blend', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(target)
            })
                .then(res => res.json())
                .then(result => {
                    if (!result.success) {
                        alert(result.message || 'ç”µç…¤é…æ¯”è®¡ç®—å¤±è´¥');
                        return;
                    }

                    const plans = result.plans;
                    const resultPanel = document.getElementById("electric-result");
                    const listDiv = document.getElementById("electric-plan-list");

                    listDiv.innerHTML = "";

                    plans.forEach((plan, index) => {
                        const isBest = index === 0;
                        const taxCost = (plan.mix_cost * 1.13).toFixed(2);

                        let card = document.createElement("div");
                        card.className = "border border-gray-300 rounded-lg p-4";

                        card.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div class="font-semibold text-lg">
                                    ç”µç…¤æ–¹æ¡ˆ ${index + 1}
                                    ${isBest ? '<span class="text-red-600">(æœ€ä¼˜)</span>' : ''}
                                </div>
                                <div class="text-right text-gray-700">
                                    <div>æˆæœ¬ï¼ˆä¸å«ç¨ï¼‰ï¼š<span class="font-bold text-blue-600">${plan.mix_cost} å…ƒ/å¨</span></div>
                                    <div>æˆæœ¬ï¼ˆå«ç¨ä»·ï¼‰ï¼š<span class="font-bold text-red-600">${taxCost} å…ƒ/å¨</span></div>
                                    <div>çƒ­å€¼ï¼š<span class="font-bold">${plan.mix_calorific} kcal</span></div>
                                </div>
                            </div>
                        `;

                        let detailBox = document.createElement("div");
                        detailBox.className = "hidden mt-3 bg-gray-50 p-3 rounded";
                        let itemsHTML = plan.items.map(item => {
                            const unitCost = item.price + item.short_transport + item.screening_fee + item.crushing_fee + 1.8;
                            const subtotal = unitCost * item.ratio;
                            const taxSubtotal = (subtotal * 1.13).toFixed(2);

                            return `
                                <div class="py-2 text-sm border-b last:border-0">
                                    <div class="flex justify-between">
                                        <span class="font-medium">${item.name}</span>
                                        <span>${(item.ratio * 100).toFixed(2)}%</span>
                                    </div>

                                    <div class="text-gray-600 mt-1">
                                        ğŸ”¥ çƒ­å€¼ï¼š<span class="font-semibold">${item.calorific}</span> å¤§å¡
                                    </div>

                                    <div class="text-gray-700 mt-1 flex justify-between">
                                        <span>æˆæœ¬å…¬å¼ï¼š</span>
                                        <span>
                                            (${item.price} + ${item.short_transport} + ${item.screening_fee} + ${item.crushing_fee} + 1.8)
                                            Ã— ${item.ratio.toFixed(4)}
                                            = <strong>${subtotal.toFixed(2)}</strong>
                                        </span>
                                    </div>
                                    <div class="text-gray-700 mt-1 flex justify-between">
                                        <span>å«ç¨æˆæœ¬ï¼š</span>
                                        <span class="text-red-600 font-medium">${taxSubtotal} å…ƒ/å¨</span>
                                    </div>
                                </div>
                            `;
                        }).join("");

                        detailBox.innerHTML = `
                            ${itemsHTML}
                            <div class="border-t pt-2 mt-2 font-bold flex justify-between">
                                <span>æ€»æˆæœ¬ï¼ˆä¸å«ç¨ï¼‰ï¼š</span>
                                <span>${plan.mix_cost} å…ƒ/å¨</span>
                            </div>
                            <div class="font-bold flex justify-between text-red-600">
                                <span>æ€»æˆæœ¬ï¼ˆå«ç¨ä»·ï¼‰ï¼š</span>
                                <span>${taxCost} å…ƒ/å¨</span>
                            </div>
                        `;

                        let btn = document.createElement("button");
                        btn.className = "mt-2 text-blue-600 underline text-sm hover:text-blue-800";
                        btn.textContent = "å±•å¼€è¯¦æƒ… â–¼";

                        btn.onclick = () => {
                            detailBox.classList.toggle("hidden");
                            btn.textContent = detailBox.classList.contains("hidden")
                                ? "å±•å¼€è¯¦æƒ… â–¼"
                                : "æ”¶èµ·è¯¦æƒ… â–²";
                        };

                        card.appendChild(btn);
                        card.appendChild(detailBox);

                        listDiv.appendChild(card);
                    });

                    resultPanel.classList.remove("hidden");
                });
        });
    }

    const coalDeleteBtn = document.getElementById('coal-delete-btn');
    if (coalDeleteBtn) {
        coalDeleteBtn.addEventListener('click', () => {
            if (!editingId) {
                alert('è¯·å…ˆåœ¨åŸç…¤åˆ—è¡¨ä¸­ç‚¹å‡»é€‰æ‹©ä¸€æ¡è¦åˆ é™¤çš„åŸç…¤ã€‚');
                return;
            }

            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥åŸç…¤å—ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤ï¼')) {
                return;
            }

            fetch(`/api/coals/${editingId}`, {
                method: 'DELETE'
            })
                .then(res => res.json())
                .then(data => {
                    if (!data.success) {
                        alert(data.message || 'åˆ é™¤å¤±è´¥');
                        return;
                    }

                    alert('åˆ é™¤æˆåŠŸï¼');
                    resetCoalFormState();
                    loadCoals();
                });
        });
    }

    window.onload = () => {
        loadCoals();
    };
</script>
</body>
</html>